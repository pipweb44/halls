{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة {{ hall.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --gold-primary: #FFD700;
    --gold-secondary: #FFA500;
    --gold-dark: #B8860B;
    --black-primary: #000000;
    --black-secondary: #1a1a1a;
    --black-tertiary: #2d2d2d;
}

.hall-management {
    background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.management-header {
    background: rgba(26, 26, 26, 0.95);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 2px solid rgba(255, 215, 0, 0.3);
    position: relative;
    overflow: hidden;
}

.management-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--gold-primary), var(--gold-secondary));
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.hall-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.hall-icon {
    width: 80px;
    height: 80px;
    background: var(--gold-primary);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.hall-icon i {
    font-size: 2.5rem;
    color: var(--black-primary);
}

.hall-info h1 {
    color: var(--gold-primary);
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
}

.hall-info p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn-action {
    padding: 0.8rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary-action {
    background: var(--gold-primary);
    color: var(--black-primary);
    border: none;
}

.btn-secondary-action {
    background: transparent;
    color: var(--gold-primary);
    border: 2px solid var(--gold-primary);
}

.btn-action:hover {
    transform: translateY(-2px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: rgba(26, 26, 26, 0.95);
    border-radius: 15px;
    padding: 2rem;
    border: 2px solid rgba(255, 215, 0, 0.2);
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    border-color: var(--gold-primary);
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: var(--gold-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.stat-icon i {
    font-size: 1.5rem;
    color: var(--black-primary);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--gold-primary);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
}

.management-tabs {
    background: rgba(26, 26, 26, 0.95);
    border-radius: 20px;
    border: 2px solid rgba(255, 215, 0, 0.2);
    overflow: hidden;
}

.tab-nav {
    display: flex;
    background: rgba(45, 45, 45, 0.8);
    border-bottom: 2px solid rgba(255, 215, 0, 0.2);
}

.tab-btn {
    flex: 1;
    padding: 1rem 2rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.tab-btn.active {
    background: var(--gold-primary);
    color: var(--black-primary);
}

.tab-btn:hover:not(.active) {
    background: rgba(255, 215, 0, 0.1);
    color: var(--gold-primary);
}

.tab-content {
    padding: 2rem;
    display: none;
}

.tab-content.active {
    display: block;
}

.services-grid, .meals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.service-card, .meal-card {
    background: rgba(45, 45, 45, 0.5);
    border-radius: 15px;
    padding: 1.5rem;
    border: 2px solid rgba(255, 215, 0, 0.2);
    transition: all 0.3s ease;
}

.service-card:hover, .meal-card:hover {
    border-color: var(--gold-primary);
    transform: translateY(-2px);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 1rem;
}

.card-title {
    color: var(--gold-primary);
    font-size: 1.2rem;
    font-weight: 700;
    flex: 1;
}

.card-price {
    color: var(--gold-secondary);
    font-weight: 600;
}

.card-description {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 1rem;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-edit {
    background: var(--gold-primary);
    color: var(--black-primary);
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.image-card {
    background: rgba(45, 45, 45, 0.5);
    border-radius: 15px;
    overflow: hidden;
    border: 2px solid rgba(255, 215, 0, 0.2);
    transition: all 0.3s ease;
}

.image-card:hover {
    border-color: var(--gold-primary);
    transform: translateY(-2px);
}

.image-preview {
    width: 100%;
    height: 150px;
    background: rgba(45, 45, 45, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.5);
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-info {
    padding: 1rem;
}

.image-title {
    color: var(--gold-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.add-btn {
    background: rgba(45, 45, 45, 0.8);
    border: 2px dashed rgba(255, 215, 0, 0.5);
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    color: var(--gold-primary);
    text-decoration: none;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.add-btn:hover {
    background: rgba(255, 215, 0, 0.1);
    border-color: var(--gold-primary);
    color: var(--gold-primary);
}

.add-btn i {
    font-size: 2rem;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .tab-nav {
        flex-direction: column;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .services-grid, .meals-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="hall-management">
    <div class="container">
        <!-- Management Header -->
        <div class="management-header">
            <div class="header-content">
                <div class="hall-title">
                    <div class="hall-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="hall-info">
                        <h1>{{ hall.name }}</h1>
                        <p><i class="fas fa-map-marker-alt me-2"></i>{{ hall.city.name }}, {{ hall.governorate.name }}</p>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="{% url 'hall_booking:hall_schedule_management' hall.id %}" class="btn-action btn-primary-action">
                        <i class="fas fa-calendar-alt"></i>
                        إدارة الجدولة
                    </a>
                    <a href="{% url 'hall_booking:hall_reports' hall.id %}" class="btn-action btn-secondary-action">
                        <i class="fas fa-chart-bar"></i>
                        التقارير
                    </a>
                    <a href="{% url 'hall_booking:hall_detail' hall.id %}" class="btn-action btn-secondary-action">
                        <i class="fas fa-eye"></i>
                        معاينة القاعة
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-number">{{ total_bookings }}</div>
                <div class="stat-label">إجمالي الحجوزات</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number">{{ pending_bookings }}</div>
                <div class="stat-label">في الانتظار</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number">{{ approved_bookings }}</div>
                <div class="stat-label">موافق عليها</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number">{{ hall.capacity }}</div>
                <div class="stat-label">السعة القصوى</div>
            </div>
        </div>

        <!-- Management Tabs -->
        <div class="management-tabs">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('services')">
                    <i class="fas fa-concierge-bell"></i>
                    الخدمات
                </button>
                <button class="tab-btn" onclick="showTab('meals')">
                    <i class="fas fa-utensils"></i>
                    الوجبات
                </button>
                <button class="tab-btn" onclick="showTab('images')">
                    <i class="fas fa-images"></i>
                    الصور
                </button>
                <button class="tab-btn" onclick="showTab('bookings')">
                    <i class="fas fa-calendar-alt"></i>
                    الحجوزات القادمة
                </button>
            </div>

            <!-- Services Tab -->
            <div id="services-tab" class="tab-content active">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-gold">الخدمات المتاحة</h3>
                    <button class="btn-action btn-primary-action" onclick="addService()">
                        <i class="fas fa-plus"></i>
                        إضافة خدمة
                    </button>
                </div>
                
                <div class="services-grid">
                    {% for service in hall_services %}
                    <div class="service-card" 
                         data-id="{{ service.id }}" 
                         data-name="{{ service.name }}" 
                         data-description="{{ service.description }}" 
                         data-price="{{ service.price }}">
                        <div class="card-header">
                            <div class="card-title">{{ service.name }}</div>
                            <div class="card-price">{{ service.price }} جنيه</div>
                        </div>
                        <div class="card-description">{{ service.description|default:"لا يوجد وصف" }}</div>
                        <div class="card-actions">
                            <button class="btn-sm btn-edit" onclick="editServiceFromCard(this)">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteService({{ service.id }})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <p class="text-muted">لا توجد خدمات مضافة بعد</p>
                    </div>
                    {% endfor %}
                    
                    <div class="add-btn" onclick="addService()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة خدمة جديدة</span>
                    </div>
                </div>
            </div>

            <!-- Meals Tab -->
            <div id="meals-tab" class="tab-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-gold">الوجبات المتاحة</h3>
                    <button class="btn-action btn-primary-action" onclick="addMeal()">
                        <i class="fas fa-plus"></i>
                        إضافة وجبة
                    </button>
                </div>
                
                <div class="meals-grid">
                    {% for meal in hall_meals %}
                    <div class="meal-card" 
                         data-id="{{ meal.id }}" 
                         data-name="{{ meal.name }}" 
                         data-description="{{ meal.description }}" 
                         data-price="{{ meal.price_per_person }}"
                         data-type="{{ meal.meal_type }}"
                         data-vegetarian="{{ meal.is_vegetarian|yesno:'true,false' }}">
                        <div class="card-header">
                            <div class="card-title">{{ meal.name }}</div>
                            <div class="card-price">{{ meal.price_per_person }} جنيه/فرد</div>
                        </div>
                        <div class="card-description">
                            <span class="badge bg-primary me-2">{{ meal.get_meal_type_display }}</span>
                            {% if meal.is_vegetarian %}<span class="badge bg-success">نباتي</span>{% endif %}
                            <p class="mt-2">{{ meal.description|default:"لا يوجد وصف" }}</p>
                        </div>
                        <div class="card-actions">
                            <button class="btn-sm btn-edit" onclick="editMealFromCard(this)">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteMeal({{ meal.id }})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <p class="text-muted">لا توجد وجبات مضافة بعد</p>
                    </div>
                    {% endfor %}
                    
                    <div class="add-btn" onclick="addMeal()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة وجبة جديدة</span>
                    </div>
                </div>
            </div>

            <!-- Images Tab -->
            <div id="images-tab" class="tab-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-gold">صور القاعة</h3>
                    <button class="btn-action btn-primary-action" onclick="addImage()">
                        <i class="fas fa-plus"></i>
                        إضافة صورة
                    </button>
                </div>
                
                <div class="images-grid">
                    {% for image in hall_images %}
                    <div class="image-card" data-id="{{ image.id }}">
                        <div class="image-preview" onclick="viewImageFullscreen('{{ image.image.url }}', '{{ image.title|escapejs }}')">
                            {% if image.image %}
                            <img src="{{ image.image.url }}" alt="{{ image.title }}" loading="lazy">
                            <div class="image-overlay">
                                <i class="fas fa-search-plus"></i>
                            </div>
                            {% else %}
                            <div class="no-image">
                                <i class="fas fa-image fa-3x"></i>
                                <p>لا توجد صورة</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="image-info">
                            <div class="image-title">{{ image.title|default:"بدون عنوان" }}</div>
                            <div class="image-meta">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ image.created_at|date:"Y-m-d" }}
                                </small>
                            </div>
                            <div class="card-actions">
                                <button class="btn-sm btn-view" onclick="viewImageFullscreen('{{ image.image.url }}', '{{ image.title|escapejs }}')" title="عرض كامل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-sm btn-delete" onclick="deleteImage({{ image.id }})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <div class="empty-state">
                            <i class="fas fa-images fa-4x text-muted mb-3"></i>
                            <p class="text-muted">لا توجد صور مضافة بعد</p>
                            <button class="btn btn-warning" onclick="addImage()">
                                <i class="fas fa-plus me-2"></i>إضافة أول صورة
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="add-btn" onclick="addImage()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة صورة جديدة</span>
                    </div>
                </div>
            </div>

            <!-- Bookings Tab -->
            <div id="bookings-tab" class="tab-content">
                <h3 class="text-gold mb-3">الحجوزات القادمة</h3>
                
                {% if upcoming_bookings %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>العميل</th>
                                <th>الحدث</th>
                                <th>التاريخ والوقت</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in upcoming_bookings %}
                            <tr>
                                <td>{{ booking.customer_name }}</td>
                                <td>{{ booking.event_title }}</td>
                                <td>{{ booking.start_datetime|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <span class="badge bg-{% if booking.status == 'approved' %}success{% elif booking.status == 'pending' %}warning{% else %}danger{% endif %}">
                                        {{ booking.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn-sm btn-edit" onclick="viewBooking({{ booking.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center">
                    <p class="text-muted">لا توجد حجوزات قادمة</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// إدارة الخدمات
function addService() {
    // إعداد النموذج للإضافة
    document.getElementById('serviceModalLabel').textContent = 'إضافة خدمة جديدة';
    document.getElementById('serviceAction').value = 'add';
    document.getElementById('serviceId').value = '';
    document.getElementById('serviceName').value = '';
    document.getElementById('serviceDescription').value = '';
    document.getElementById('servicePrice').value = '';
    
    // إظهار النموذج
    const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
    modal.show();
}

function editServiceFromCard(button) {
    const card = button.closest('.service-card');
    const serviceId = card.dataset.id;
    const name = card.dataset.name;
    const description = card.dataset.description;
    const price = card.dataset.price;
    
    // إعداد النموذج للتعديل
    document.getElementById('serviceModalLabel').textContent = 'تعديل الخدمة';
    document.getElementById('serviceAction').value = 'edit';
    document.getElementById('serviceId').value = serviceId;
    document.getElementById('serviceName').value = name || '';
    document.getElementById('serviceDescription').value = description || '';
    document.getElementById('servicePrice').value = price || '';
    
    // إظهار النموذج
    const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
    modal.show();
}

function deleteService(serviceId) {
    if (confirm('هل أنت متأكد من حذف هذه الخدمة؟')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('action', 'delete');
        formData.append('service_id', serviceId);
        
        fetch('{% url "hall_booking:manage_hall_service" hall.id %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        });
    }
}

// إدارة الوجبات
function addMeal() {
    // إعداد النموذج للإضافة
    document.getElementById('mealModalLabel').textContent = 'إضافة وجبة جديدة';
    document.getElementById('mealAction').value = 'add';
    document.getElementById('mealId').value = '';
    document.getElementById('mealName').value = '';
    document.getElementById('mealDescription').value = '';
    document.getElementById('mealPrice').value = '';
    document.getElementById('mealType').value = 'main';
    document.getElementById('isVegetarian').checked = false;
    
    // إظهار النموذج
    const modal = new bootstrap.Modal(document.getElementById('mealModal'));
    modal.show();
}

function editMealFromCard(button) {
    const card = button.closest('.meal-card');
    const mealId = card.dataset.id;
    const name = card.dataset.name;
    const description = card.dataset.description;
    const price = card.dataset.price;
    const mealType = card.dataset.type;
    const isVegetarian = card.dataset.vegetarian === 'true';
    
    // إعداد النموذج للتعديل
    document.getElementById('mealModalLabel').textContent = 'تعديل الوجبة';
    document.getElementById('mealAction').value = 'edit';
    document.getElementById('mealId').value = mealId;
    document.getElementById('mealName').value = name || '';
    document.getElementById('mealDescription').value = description || '';
    document.getElementById('mealPrice').value = price || '';
    document.getElementById('mealType').value = mealType || 'main';
    document.getElementById('isVegetarian').checked = isVegetarian;
    
    // إظهار النموذج
    const modal = new bootstrap.Modal(document.getElementById('mealModal'));
    modal.show();
}

function deleteMeal(mealId) {
    if (confirm('هل أنت متأكد من حذف هذه الوجبة؟')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('action', 'delete');
        formData.append('meal_id', mealId);
        
        fetch('{% url "hall_booking:manage_hall_meal" hall.id %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        });
    }
}

// إدارة الصور
function addImage() {
    // إعداد النموذج لإضافة صورة
    document.getElementById('imageTitle').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    
    // إظهار النموذج
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

function deleteImage(imageId) {
    if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('action', 'delete');
        formData.append('image_id', imageId);
        
        fetch('{% url "hall_booking:manage_hall_image" hall.id %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        });
    }
}

function viewBooking(bookingId) {
    showBookingModal(bookingId);
}

function showBookingModal(bookingId) {
    // جلب تفاصيل الحجز وعرضها في النافذة المنبثقة
    fetch(`/booking/${bookingId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('bookingDetails').innerHTML = data.html;
                const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            } else {
                alert('خطأ في جلب تفاصيل الحجز');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في الاتصال');
        });
}

// معالجات الأحداث للنماذج
document.addEventListener('DOMContentLoaded', function() {
    // معالج نموذج الخدمات
    document.getElementById('serviceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`{% url "hall_booking:manage_hall_service" hall.id %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('serviceModal')).hide();
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في الاتصال');
        });
    });

    // معالج نموذج الوجبات
    document.getElementById('mealForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`{% url "hall_booking:manage_hall_meal" hall.id %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('mealModal')).hide();
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في الاتصال');
        });
    });

    // معالج نموذج الصور
    document.getElementById('imageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`{% url "hall_booking:manage_hall_image" hall.id %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
                location.reload();
            } else {
                alert('خطأ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في الاتصال');
        });
    });

    // معاينة الصورة قبل الرفع
    document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // دالة عرض الصورة بحجم كامل
    window.viewImageFullscreen = function(imageUrl, title) {
        const modal = document.createElement('div');
        modal.className = 'image-fullscreen-modal';
        modal.innerHTML = `
            <div class="fullscreen-backdrop" onclick="closeImageModal()">
                <div class="fullscreen-content" onclick="event.stopPropagation()">
                    <div class="fullscreen-header">
                        <h5>${title || 'صورة القاعة'}</h5>
                        <button class="close-btn" onclick="closeImageModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="fullscreen-image">
                        <img src="${imageUrl}" alt="${title}" />
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
    };
    
    window.closeImageModal = function() {
        const modal = document.querySelector('.image-fullscreen-modal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }
    };
});
</script>

<!-- نافذة عرض الصورة بحجم كامل -->
<style>
.image-fullscreen-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-fullscreen-modal.show {
    opacity: 1;
}

.fullscreen-backdrop {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.fullscreen-content {
    max-width: 90%;
    max-height: 90%;
    background: var(--black-secondary);
    border-radius: 15px;
    overflow: hidden;
    cursor: default;
    border: 2px solid var(--gold-primary);
}

.fullscreen-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--black-tertiary);
    border-bottom: 1px solid var(--gold-primary);
}

.fullscreen-header h5 {
    color: var(--gold-primary);
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    color: var(--gold-primary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: var(--gold-primary);
    color: var(--black-primary);
}

.fullscreen-image {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.fullscreen-image img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 10px;
}

/* تحسينات لعرض الصور */
.image-preview {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    border-radius: 10px;
}

.image-preview img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.image-preview:hover img {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    color: var(--gold-primary);
    font-size: 2rem;
}

.image-preview:hover .image-overlay {
    opacity: 1;
}

.no-image {
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(45, 45, 45, 0.5);
    color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
}

.image-meta {
    margin: 0.5rem 0;
}

.btn-view {
    background: var(--gold-primary);
    color: var(--black-primary);
}

.btn-view:hover {
    background: var(--gold-secondary);
}

.empty-state {
    padding: 3rem;
    text-align: center;
}

@media (max-width: 768px) {
    .fullscreen-content {
        max-width: 95%;
        max-height: 95%;
    }
    
    .fullscreen-image img {
        max-height: 60vh;
    }
}
</style>

<!-- Modal للخدمات -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning" id="serviceModalLabel">إدارة الخدمة</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="serviceForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="serviceAction" name="action" value="add">
                    <input type="hidden" id="serviceId" name="service_id" value="">
                    
                    <div class="mb-3">
                        <label for="serviceName" class="form-label text-warning">اسم الخدمة</label>
                        <input type="text" class="form-control bg-secondary text-light border-warning" id="serviceName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="serviceDescription" class="form-label text-warning">وصف الخدمة</label>
                        <textarea class="form-control bg-secondary text-light border-warning" id="serviceDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="servicePrice" class="form-label text-warning">السعر (جنيه)</label>
                        <input type="number" class="form-control bg-secondary text-light border-warning" id="servicePrice" name="price" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer border-warning">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal للوجبات -->
<div class="modal fade" id="mealModal" tabindex="-1" aria-labelledby="mealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning" id="mealModalLabel">إدارة الوجبة</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="mealForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="mealAction" name="action" value="add">
                    <input type="hidden" id="mealId" name="meal_id" value="">
                    
                    <div class="mb-3">
                        <label for="mealName" class="form-label text-warning">اسم الوجبة</label>
                        <input type="text" class="form-control bg-secondary text-light border-warning" id="mealName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mealDescription" class="form-label text-warning">وصف الوجبة</label>
                        <textarea class="form-control bg-secondary text-light border-warning" id="mealDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mealPrice" class="form-label text-warning">السعر للفرد (جنيه)</label>
                                <input type="number" class="form-control bg-secondary text-light border-warning" id="mealPrice" name="price_per_person" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mealType" class="form-label text-warning">نوع الوجبة</label>
                                <select class="form-select bg-secondary text-light border-warning" id="mealType" name="meal_type" required>
                                    <option value="appetizer">مقبلات</option>
                                    <option value="main" selected>طبق رئيسي</option>
                                    <option value="dessert">حلويات</option>
                                    <option value="drink">مشروبات</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isVegetarian" name="is_vegetarian">
                            <label class="form-check-label text-warning" for="isVegetarian">
                                وجبة نباتية
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-warning">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal للصور -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning" id="imageModalLabel">إضافة صورة جديدة</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="imageForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="action" value="upload">
                    
                    <div class="mb-3">
                        <label for="imageTitle" class="form-label text-warning">عنوان الصورة</label>
                        <input type="text" class="form-control bg-secondary text-light border-warning" id="imageTitle" name="title" placeholder="اختياري">
                    </div>
                    
                    <div class="mb-3">
                        <label for="imageFile" class="form-label text-warning">اختر الصورة</label>
                        <input type="file" class="form-control bg-secondary text-light border-warning" id="imageFile" name="image" accept="image/*" required>
                    </div>
                    
                    <div id="imagePreview" class="text-center" style="display: none;">
                        <img id="previewImg" src="" alt="معاينة" class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                </div>
                <div class="modal-footer border-warning">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">رفع الصورة</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal لعرض تفاصيل الحجز -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning" id="bookingModalLabel">تفاصيل الحجز</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetails">
                <!-- سيتم تحميل تفاصيل الحجز هنا -->
            </div>
            <div class="modal-footer border-warning">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <div class="booking-actions">
                    <!-- أزرار إدارة الحجز ستظهر هنا -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
