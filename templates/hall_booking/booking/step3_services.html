{% extends 'base.html' %}
{% load static %}

{% block title %}اختيار الخدمات - حجز {{ hall.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --gold-primary: #FFD700;
    --gold-secondary: #FFA500;
    --gold-dark: #B8860B;
    --black-primary: #000000;
    --black-secondary: #1a1a1a;
    --black-tertiary: #2d2d2d;
    --black-light: #404040;
}

.booking-wizard-section {
    background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.wizard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Progress Bar */
.progress-bar {
    background: rgba(26, 26, 26, 0.95);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 3rem;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: rgba(255, 215, 0, 0.3);
    z-index: 1;
}

.progress-steps::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 50%;
    height: 2px;
    background: var(--gold-primary);
    z-index: 2;
    transition: width 0.3s ease;
}

.step {
    background: rgba(45, 45, 45, 0.8);
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 700;
    position: relative;
    z-index: 3;
    transition: all 0.3s ease;
}

.step.completed {
    background: var(--gold-primary);
    border-color: var(--gold-primary);
    color: var(--black-primary);
}

.step.active {
    background: var(--gold-primary);
    border-color: var(--gold-primary);
    color: var(--black-primary);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.step-label {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--gold-primary);
    font-size: 0.9rem;
    font-weight: 600;
    white-space: nowrap;
}

/* Services Section */
.services-section {
    background: rgba(26, 26, 26, 0.95);
    border-radius: 20px;
    padding: 3rem;
    border: 1px solid rgba(255, 215, 0, 0.3);
    margin-bottom: 2rem;
}

.section-header {
    text-align: center;
    margin-bottom: 3rem;
}

.section-header h2 {
    color: var(--gold-primary);
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 1rem;
}

.section-header p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
}

.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
}

.service-card {
    background: rgba(45, 45, 45, 0.5);
    border-radius: 15px;
    padding: 2rem;
    border: 2px solid rgba(255, 215, 0, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.service-card:hover {
    border-color: var(--gold-primary);
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(255, 215, 0, 0.2);
}

.service-card.selected {
    border-color: var(--gold-primary);
    background: rgba(255, 215, 0, 0.1);
    box-shadow: 0 15px 30px rgba(255, 215, 0, 0.3);
}

.service-checkbox {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 24px;
    height: 24px;
    accent-color: var(--gold-primary);
}

.service-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.service-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--black-primary);
    font-size: 1.5rem;
}

.service-info h3 {
    color: var(--gold-primary);
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0;
}

.service-price {
    color: var(--gold-secondary);
    font-size: 1.1rem;
    font-weight: 600;
}

.service-description {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
}

.quantity-label {
    color: var(--gold-primary);
    font-weight: 600;
}

.quantity-input {
    background: rgba(45, 45, 45, 0.8);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    color: white;
    padding: 0.5rem;
    width: 80px;
    text-align: center;
}

/* Navigation */
.navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 0;
}

.nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    border-radius: 15px;
    text-decoration: none;
    font-weight: 700;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-secondary {
    background: rgba(45, 45, 45, 0.8);
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.btn-secondary:hover {
    background: rgba(45, 45, 45, 1);
    color: white;
    border-color: var(--gold-primary);
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
    color: var(--black-primary);
    box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 35px rgba(255, 215, 0, 0.4);
    text-decoration: none;
    color: var(--black-primary);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Summary */
.selection-summary {
    background: rgba(45, 45, 45, 0.5);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.summary-header {
    color: var(--gold-primary);
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
}

.summary-item:last-child {
    border-bottom: none;
    font-weight: 700;
    color: var(--gold-primary);
}

.summary-name {
    color: rgba(255, 255, 255, 0.9);
}

.summary-price {
    color: var(--gold-primary);
    font-weight: 600;
}

/* Responsive */
@media (max-width: 768px) {
    .wizard-container {
        padding: 0 0.5rem;
    }
    
    .services-section {
        padding: 2rem;
    }
    
    .services-grid {
        grid-template-columns: 1fr;
    }
    
    .progress-steps {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step-label {
        position: static;
        transform: none;
        margin-top: 0.5rem;
    }
    
    .navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .nav-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<section class="booking-wizard-section">
    <div class="wizard-container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="step completed">
                    <i class="fas fa-calendar"></i>
                    <div class="step-label">التاريخ</div>
                </div>
                <div class="step completed">
                    <i class="fas fa-clock"></i>
                    <div class="step-label">الوقت</div>
                </div>
                <div class="step active">
                    <i class="fas fa-concierge-bell"></i>
                    <div class="step-label">الخدمات</div>
                </div>
                <div class="step">
                    <i class="fas fa-utensils"></i>
                    <div class="step-label">الوجبات</div>
                </div>
                <div class="step">
                    <i class="fas fa-user"></i>
                    <div class="step-label">المعلومات</div>
                </div>
                <div class="step">
                    <i class="fas fa-check"></i>
                    <div class="step-label">التأكيد</div>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div class="services-section">
            <div class="section-header">
                <h2>اختر الخدمات الإضافية</h2>
                <p>يمكنك اختيار الخدمات التي تحتاجها لحدثك (اختياري)</p>
            </div>

            <form method="post" id="servicesForm">
                {% csrf_token %}
                
                {% if hall_services %}
                <div class="services-grid">
                    {% for service in hall_services %}
                    <div class="service-card" onclick="toggleService({{ service.id }})">
                        <input type="checkbox" 
                               name="selected_services" 
                               value="{{ service.id }}" 
                               id="service_{{ service.id }}"
                               class="service-checkbox"
                               onchange="updateSelection()">
                        
                        <div class="service-header">
                            <div class="service-icon">
                                <i class="fas fa-concierge-bell"></i>
                            </div>
                            <div class="service-info">
                                <h3>{{ service.name }}</h3>
                                <div class="service-price">{{ service.price }} جنيه</div>
                            </div>
                        </div>
                        
                        {% if service.description %}
                        <div class="service-description">
                            {{ service.description }}
                        </div>
                        {% endif %}
                        
                        <div class="quantity-selector" style="display: none;" id="quantity_{{ service.id }}">
                            <span class="quantity-label">الكمية:</span>
                            <input type="number" 
                                   name="service_quantity_{{ service.id }}" 
                                   value="1" 
                                   min="1" 
                                   max="10"
                                   class="quantity-input"
                                   onchange="updateSelection()">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Selection Summary -->
                <div class="selection-summary" id="selectionSummary" style="display: none;">
                    <div class="summary-header">ملخص الخدمات المختارة</div>
                    <div id="summaryContent"></div>
                </div>
                
                {% else %}
                <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                    <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--gold-primary);"></i>
                    <h3>لا توجد خدمات إضافية متاحة</h3>
                    <p>يمكنك المتابعة إلى الخطوة التالية</p>
                </div>
                {% endif %}
            </form>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <a href="{% url 'hall_booking:booking_step2_time' hall.id %}" class="nav-btn btn-secondary">
                <i class="fas fa-arrow-right"></i>
                السابق
            </a>
            
            <button type="button" onclick="proceedToNext()" class="nav-btn btn-primary">
                التالي
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>
</section>

<script>
function toggleService(serviceId) {
    const checkbox = document.getElementById(`service_${serviceId}`);
    const card = checkbox.closest('.service-card');
    const quantityDiv = document.getElementById(`quantity_${serviceId}`);
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        card.classList.add('selected');
        quantityDiv.style.display = 'flex';
    } else {
        card.classList.remove('selected');
        quantityDiv.style.display = 'none';
    }
    
    updateSelection();
}

function updateSelection() {
    const selectedServices = document.querySelectorAll('input[name="selected_services"]:checked');
    const summaryDiv = document.getElementById('selectionSummary');
    const summaryContent = document.getElementById('summaryContent');
    
    if (selectedServices.length > 0) {
        summaryDiv.style.display = 'block';
        let totalPrice = 0;
        let summaryHTML = '';
        
        selectedServices.forEach(checkbox => {
            const serviceId = checkbox.value;
            const serviceName = checkbox.closest('.service-card').querySelector('h3').textContent;
            const servicePrice = parseFloat(checkbox.closest('.service-card').querySelector('.service-price').textContent.replace(' جنيه', ''));
            const quantityInput = document.querySelector(`input[name="service_quantity_${serviceId}"]`);
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            const itemTotal = servicePrice * quantity;
            
            totalPrice += itemTotal;
            
            summaryHTML += `
                <div class="summary-item">
                    <span class="summary-name">${serviceName} (${quantity})</span>
                    <span class="summary-price">${itemTotal} جنيه</span>
                </div>
            `;
        });
        
        summaryHTML += `
            <div class="summary-item">
                <span class="summary-name">إجمالي الخدمات</span>
                <span class="summary-price">${totalPrice} جنيه</span>
            </div>
        `;
        
        summaryContent.innerHTML = summaryHTML;
    } else {
        summaryDiv.style.display = 'none';
    }
}

function proceedToNext() {
    // Save selected services to session storage
    const selectedServices = [];
    const checkboxes = document.querySelectorAll('input[name="selected_services"]:checked');
    
    checkboxes.forEach(checkbox => {
        const serviceId = checkbox.value;
        const quantityInput = document.querySelector(`input[name="service_quantity_${serviceId}"]`);
        const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
        
        selectedServices.push({
            id: serviceId,
            quantity: quantity
        });
    });
    
    sessionStorage.setItem('selectedServices', JSON.stringify(selectedServices));
    
    // Proceed to next step
    window.location.href = "{% url 'hall_booking:booking_step4_meals' hall.id %}";
}

// Prevent checkbox click from triggering card click
document.querySelectorAll('.service-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});

// Load previously selected services from session storage
document.addEventListener('DOMContentLoaded', function() {
    const savedServices = sessionStorage.getItem('selectedServices');
    if (savedServices) {
        const selectedServices = JSON.parse(savedServices);
        selectedServices.forEach(service => {
            const checkbox = document.getElementById(`service_${service.id}`);
            if (checkbox) {
                checkbox.checked = true;
                const card = checkbox.closest('.service-card');
                const quantityDiv = document.getElementById(`quantity_${service.id}`);
                const quantityInput = document.querySelector(`input[name="service_quantity_${service.id}"]`);
                
                card.classList.add('selected');
                quantityDiv.style.display = 'flex';
                if (quantityInput) {
                    quantityInput.value = service.quantity;
                }
            }
        });
        updateSelection();
    }
});
</script>
{% endblock %}
