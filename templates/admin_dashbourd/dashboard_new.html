{% extends 'admin_dashbourd/base.html' %}
{% load custom_filters %}

{% block page_title %}لوحة التحكم{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.rtl.min.css' rel='stylesheet' />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Base styles for all devices */
    #calendar, .chart-container {
        background: #fff;
        border-radius: 0.35rem;
        padding: 1rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        border-left: 0.25rem solid #4e73df;
        transition: transform 0.3s;
        margin-bottom: 1rem;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        min-width: 0; /* Fix for chart.js responsiveness */
    }
    
    .progress {
        height: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Calendar responsive styles */
    .fc-toolbar {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .fc-toolbar.fc-header-toolbar {
        margin-bottom: 0.5em;
    }
    
    .fc-toolbar-title {
        font-size: 1.1rem;
        margin: 0.5em 0;
    }
    
    .fc-button {
        padding: 0.2rem 0.4rem;
        font-size: 0.8rem;
        margin: 2px;
    }
    
    /* Responsive table */
    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .d-sm-flex {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem !important;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .fc-header-toolbar {
            flex-wrap: wrap;
        }
        
        .fc-toolbar-chunk {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        
        .fc-button-group {
            margin: 0.2rem;
        }
        
        .chart-container {
            height: 250px;
            padding: 0.5rem;
        }
        
        /* Adjust statistics cards for mobile */
        .col-xl-3.col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
    
    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) and (max-width: 767.98px) {
        .col-xl-3.col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4">
    <h1 class="h3 mb-3 mb-md-0 text-gray-800">لوحة التحكم</h1>
    <div class="d-flex align-items-center">
        <span class="text-nowrap">{{ today|date:"d M Y" }}</span>
        <i class="fas fa-calendar-alt text-gray-500"></i>
    </div>
</div>

<!-- Statistics Section -->
{% include 'admin_dashbourd/includes/statistics.html' %}

<!-- Calendar Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">تقويم الحجوزات</h6>
                <button id="toggleTableView" class="btn btn-sm btn-primary">
                    <i class="fas fa-table"></i> <span>عرض الجدول</span>
                </button>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
                <div id="upcomingBookingsSection" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="upcomingBookings" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>العميل</th>
                                    <th>القاعة</th>
                                    <th>التاريخ</th>
                                    <th>الوقت</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in upcoming_bookings %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ booking.customer_name }}</td>
                                    <td>{{ booking.hall.name }}</td>
                                    <td>{{ booking.start_datetime|date:"Y-m-d" }}</td>
                                    <td>{{ booking.start_datetime|time:"H:i" }} - {{ booking.end_datetime|time:"H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{{ booking.status }}">
                                            {{ booking.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'hall_booking:admin_booking_detail' booking.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ar-tn.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Calendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ar-tn',
        direction: 'rtl',
        initialView: 'dayGridMonth',
        headerToolbar: {
            right: 'today prev,next',
            center: 'title',
            left: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '{% url "hall_booking:admin_bookings_calendar" %}',
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        eventDidMount: function(info) {
            // Add tooltip
            $(info.el).tooltip({
                title: info.event.extendedProps.description,
                placement: 'top',
                trigger: 'hover',
                container: 'body'
            });
        },
        eventClick: function(info) {
            // Handle event click
            window.location.href = info.event.url;
            info.jsEvent.preventDefault();
        }
    });

    calendar.render();

    // Toggle between calendar and table view
    $('#toggleTableView').on('click', function() {
        $('#calendar').toggleClass('d-none');
        $('#upcomingBookingsSection').toggleClass('d-none');
        $(this).find('i').toggleClass('fa-table fa-calendar');
        $(this).find('span').text(function(i, text) {
            return text === 'عرض الجدول' ? 'عرض التقويم' : 'عرض الجدول';
        });
    });

    // Initialize Monthly Bookings Chart
    const monthlyCtx = document.getElementById('monthlyBookingsChart');
    if (monthlyCtx) {
        const monthlyChart = new Chart(monthlyCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: JSON.parse('{{ monthly_labels|escapejs }}'),
                datasets: [{
                    label: 'عدد الحجوزات',
                    data: JSON.parse('{{ monthly_data|escapejs }}'),
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    pointRadius: 3,
                    pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointBorderColor: 'rgba(78, 115, 223, 1)',
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        rtl: true
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Initialize Booking Status Chart
    const statusCtx = document.getElementById('bookingStatusChart');
    if (statusCtx) {
        const statusChart = new Chart(statusCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: JSON.parse('{{ status_labels|escapejs }}'),
                datasets: [{
                    data: JSON.parse('{{ status_data|escapejs }}'),
                    backgroundColor: [
                        '#4e73df', // Primary
                        '#1cc88a', // Success
                        '#f6c23e', // Warning
                        '#e74a3b', // Danger
                        '#858796'  // Secondary
                    ],
                    hoverBackgroundColor: [
                        '#2e59d9',
                        '#17a673',
                        '#dda20a',
                        '#be2617',
                        '#666974'
                    ],
                    hoverBorderColor: 'rgba(234, 236, 244, 1)'
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        rtl: true,
                        labels: {
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        rtl: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
    }
});
</script>
{% endblock %}
