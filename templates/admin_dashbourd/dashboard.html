{% extends 'admin_dashbourd/base.html' %}

{% block page_title %}الرئيسية{% endblock %}

{% block content %}
{% with percentage=available_halls|default:0|floatformat:0 %}

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Monthly Bookings Chart -->
    <div class="col-xl-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">إحصائيات الحجوزات الشهرية</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="monthlyBookingsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Status Distribution -->
    <div class="col-xl-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">توزيع الحجوزات</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="bookingStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hall Occupancy -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">معدل إشغال القاعات</h6>
            </div>
            <div class="card-body">
                {% for hall in hall_occupancy %}
                <div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">لوحة التحكم</h1>
        <div>
            <span class="me-2">{{ today|date:"d M Y" }}</span>
            <i class="fas fa-calendar-alt text-gray-500"></i>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <!-- Total Revenue Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 stat-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                إجمالي الإيرادات</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_revenue|default:0 }} د.ل</div>
                             style="width: {{ hall.occupancy_rate }}%" 
                             aria-valuenow="{{ hall.occupancy_rate }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.rtl.min.css' rel='stylesheet' />
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #calendar, .chart-container {
        background: #fff;
        border-radius: 0.35rem;
        padding: 1rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }
    .fc-toolbar-title {
        font-size: 1.25rem;
    }
    .fc-button {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .stat-card {
        border-left: 0.25rem solid #4e73df;
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card .icon {
        font-size: 2rem;
        color: #dddfeb;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .progress {
        height: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ar-tn.js'></script>
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Arabic -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animate all progress bars with data-width attribute
        const progressBars = document.querySelectorAll('[data-width]');
        progressBars.forEach(bar => {
            const width = bar.getAttribute('data-width') + '%';
            // Set initial width to 0 for animation
            bar.style.width = '0';
            // Animate to target width
            setTimeout(() => {
                bar.style.transition = 'width 1s ease-in-out';
                bar.style.width = width;
            }, 100);
        });

        // Initialize DataTable for recent bookings
        $('#recentBookings').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ar.json"
            },
            "order": [[0, "desc"]],
            "pageLength": 5,
            "responsive": true
        });

        // Initialize DataTable for upcoming bookings
        $('#upcomingBookings').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ar.json"
            },
            "order": [[3, "asc"]],
            "pageLength": 5,
            "responsive": true,
            "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            "columnDefs": [
                { "orderable": false, "targets": [6] } // Disable sorting on actions column
            ]
        });
        
        // Toggle between calendar and table view
        $('#toggleTableView').on('click', function() {
            $('#calendar').toggleClass('d-none');
            $('#upcomingBookingsSection').toggleClass('d-none');
            $(this).find('i').toggleClass('fa-table fa-calendar');
            $(this).find('span').text(function(i, text) {
                return text === 'عرض الجدول' ? 'عرض التقويم' : 'عرض الجدول';
            });
        });
    });

    // Initialize FullCalendar
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        // Initialize FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'ar-tn',
            direction: 'rtl',
            initialView: 'dayGridMonth',
            headerToolbar: {
                right: 'today prev,next',
                center: 'title',
                left: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'اليوم',
                month: 'شهري',
                week: 'أسبوعي',
                day: 'يومي'
            },
            events: {
                url: "{% url 'hall_booking:admin_bookings_calendar' %}",
                method: 'GET',
                failure: function() {
                    console.error('حدث خطأ أثناء تحميل أحداث التقويم');
                }
            },
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            firstDay: 6, // Start week on Saturday
            height: 'auto',
            navLinks: true,
            editable: false,
            dayMaxEvents: true,
            eventDidMount: function(info) {
                // Add tooltip to events
                if (info.event.extendedProps.status) {
                    new bootstrap.Tooltip(info.el, {
                        title: `
                            الحالة: ${info.event.extendedProps.status}\n
                            الزبون: ${info.event.extendedProps.customer || 'غير محدد'}\n
                            القاعة: ${info.event.extendedProps.hall || 'غير محددة'}
                        `,
                        placement: 'top',
                        trigger: 'hover',
                        container: 'body'
                    });
                }
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) {
                    window.location.href = info.event.url;
                }
            },
            loading: function(isLoading) {
                const loadingEl = document.getElementById('calendar-loading');
                if (loadingEl) {
                    loadingEl.style.display = isLoading ? 'block' : 'none';
                }
            },
            eventDisplay: 'block',
            eventClassNames: function(arg) {
                return ['fc-event-custom'];
            },
            eventContent: function(arg) {
                // Custom event content
                const timeText = arg.timeText;
                const title = arg.event.title;
                
                const eventEl = document.createElement('div');
                eventEl.className = 'fc-event-main';
                
                if (timeText) {
                    const timeEl = document.createElement('div');
                    timeEl.className = 'fc-event-time';
                    timeEl.textContent = timeText;
                    eventEl.appendChild(timeEl);
                }
                
                const titleEl = document.createElement('div');
                titleEl.className = 'fc-event-title';
                titleEl.textContent = title;
                eventEl.appendChild(titleEl);
                
                return { domNodes: [eventEl] };
            }
        });

        // Render the calendar
        calendar.render();

        // Add loading indicator
        const loadingEl = document.createElement('div');
        loadingEl.id = 'calendar-loading';
        loadingEl.className = 'text-center py-3';
        loadingEl.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">جاري التحميل...</span></div>';
        calendarEl.parentNode.insertBefore(loadingEl, calendarEl.nextSibling);
    });

    // Monthly Bookings Chart
    const monthlyCtx = document.getElementById('monthlyBookingsChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'عدد الحجوزات',
                data: {{ monthly_data|safe }},
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                borderColor: 'rgba(78, 115, 223, 1)',
                pointRadius: 3,
                pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointBorderColor: 'rgba(78, 115, 223, 1)',
                pointHoverRadius: 3,
                pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                pointHitRadius: 10,
                pointBorderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 25,
                    top: 25,
                    bottom: 0
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        maxTicksLimit: 7
                    }
                },
                y: {
                    ticks: {
                        maxTicksLimit: 5,
                        padding: 10,
                        callback: function(value) {
                            return value;
                        }
                    },
                    grid: {
                        color: 'rgb(234, 236, 244)',
                        zeroLineColor: 'rgb(234, 236, 244)',
                        drawBorder: false,
                        borderDash: [2],
                        zeroLineBorderDash: [2]
                    }
                },
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgb(255,255,255)',
                    bodyColor: '#858796',
                    titleMarginBottom: 10,
                    titleFontColor: '#6e707e',
                    titleFontSize: 14,
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    intersect: false,
                    mode: 'index',
                    caretPadding: 10,
                    callbacks: {
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y + ' حجز';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Booking Status Distribution Chart
    const statusCtx = document.getElementById('bookingStatusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_data|safe }},
                backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e', '#e74a3b', '#858796'],
                hoverBackgroundColor: ['#2e59d9', '#17a673', '#dda20a', '#be2617', '#666974'],
                hoverBorderColor: 'rgba(234, 236, 244, 1)',
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    rtl: true,
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgb(255,255,255)',
                    bodyColor: '#858796',
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '70%',
        },
    });
</script>

<!-- Custom template filter for occupancy color -->
{% load custom_filters %}

<style>
    /* Custom colors for occupancy rates */
    .bg-occupancy-low { background-color: #1cc88a !important; }
    .bg-occupancy-medium { background-color: #f6c23e !important; }
    .bg-occupancy-high { background-color: #e74a3b !important; }
</style>
{% endblock %}

<!-- System Status & Announcements -->
<div class="row mb-4">
    <!-- System Status -->
    <div class="col-md-6 mb-4 mb-md-0">
        <div class="card border-start-success shadow h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-success">حالة النظام</h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-shape icon-lg bg-success bg-opacity-10 text-success rounded-circle me-3">
                        <i class="fas fa-check"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">النظام يعمل بشكل طبيعي</h6>
                        <small class="text-muted">آخر تحديث: {{ now|date:"Y/m/d H:i" }}</small>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="icon-shape icon-lg bg-success bg-opacity-10 text-success rounded-circle me-3">
                        <i class="fas fa-database"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">قاعدة البيانات نشطة</h6>
                        <small class="text-muted">{{ total_bookings }} حجز، {{ total_users }} مستخدم</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Announcements -->
    <div class="col-md-6">
        <div class="card border-start-info shadow h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-info">إعلانات هامة</h6>
                <a href="#" class="small">عرض الكل</a>
            </div>
            <div class="card-body">
                <div class="d-flex mb-3">
                    <div class="icon-shape icon-lg bg-info bg-opacity-10 text-info rounded-circle me-3">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">تحديث جديد متاح</h6>
                        <p class="small text-muted mb-0">نسخة 1.2.0 متاحة الآن مع ميزات جديدة وتحسينات في الأداء.</p>
                    </div>
                </div>
                <div class="d-flex">
                    <div class="icon-shape icon-lg bg-info bg-opacity-10 text-info rounded-circle me-3">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">صيانة مجدولة</h6>
                        <p class="small text-muted mb-0">سيتم إيقاف النظام للصيانة يوم الجمعة القادم من الساعة 2 صباحاً حتى 4 صباحاً.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <a href="{% url 'hall_booking:admin_add_booking' %}" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-1"></i> حجز جديد
                        </a>
                        <a href="{% url 'hall_booking:admin_hall_create' %}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-plus me-1"></i> إضافة قاعة
                        </a>
                        <a href="{% url 'hall_booking:admin_reports' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-bar me-1"></i> التقارير
                        </a>
                    </div>
                    {% if unread_messages > 0 %}
                    <div class="alert alert-warning mb-0 py-2" role="alert">
                        <i class="fas fa-envelope me-1"></i>
                        لديك {{ unread_messages }} رسالة غير مقروءة
                        <a href="{% url 'hall_booking:admin_contacts_list' %}" class="alert-link me-2">عرض الرسائل</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats Row -->
<div class="row mb-4">
    <!-- Total Revenue Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">إجمالي الإيرادات</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_revenue|floatformat:2 }} ريال</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Bookings Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">إجمالي الحجوزات</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ bookings_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Bookings Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">الحجوزات المعلقة</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_bookings_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Halls Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">إجمالي القاعات</div>
                        <div class="row no-gutters align-items-center">
                            <div class="col-auto">
                                <div class="h5 mb-0 me-3 font-weight-bold text-gray-800">{{ halls_count }}</div>
                            </div>
                            <div class="col">
                                <div class="progress progress-sm me-2">
                                    <div class="progress-bar bg-info progress-bar-available" 
                                         role="progressbar"
                                         style="width: 0%"
                                         data-width="{{ percentage }}"
                                         aria-valuenow="{{ available_halls }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="{{ halls_count }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted mt-1">{{ available_halls }} قاعة متاحة ({{ percentage }}%)</div>
                    </div>
                    {% endwith %}
                    <div class="col-auto">
                        <i class="fas fa-building fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">تقويم الحجوزات</h6>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Bookings -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">الحجوزات القادمة</h6>
                <div>
                    <a href="{% url 'hall_booking:admin_bookings_list' %}" class="btn btn-sm btn-outline-primary">
                        عرض الكل <i class="fas fa-arrow-left me-1"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleTableView">
                        <i class="fas fa-table"></i> عرض الجدول
                    </button>
                </div>
            </div>
            <div class="card-body" id="upcomingBookingsSection">
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="upcomingBookings" style="width:100%">
                        <thead>
                            <tr>
                                <th>رقم الحجز</th>
                                <th>اسم القاعة</th>
                                <th>اسم المستخدم</th>
                                <th>تاريخ الحجز</th>
                                <th>المدة</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in upcoming_bookings|slice:":5" %}
                            <tr>
                                <td>#{{ booking.id }}</td>
                                <td>{{ booking.hall.name }}</td>
                                <td>{{ booking.user.get_full_name|default:booking.user.username }}</td>
                                <td>{{ booking.booking_date|date:"Y/m/d" }}</td>
                                <td>{{ booking.duration }} ساعات</td>
                                <td>
                                    <span class="badge {% if booking.status == 'confirmed' %}bg-success{% elif booking.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ booking.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'hall_booking:admin_booking_detail' booking.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="far fa-calendar-check fa-2x text-muted mb-2"></i>
                                    <p class="mb-0">لا توجد حجوزات قادمة</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Row -->
<div class="row">
    <!-- Recent Bookings -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">أحدث الحجوزات</h6>
                <a href="{% url 'hall_booking:admin_bookings_list' %}" class="btn btn-sm btn-primary">
                    عرض الكل
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>القاعة</th>
                                <th>المستخدم</th>
                                <th>التاريخ</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in recent_bookings|slice:":5" %}
                            <tr>
                                <td>
                                    <a href="{% url 'hall_booking:admin_booking_detail' booking.id %}">
                                        {{ booking.hall.name|truncatechars:20 }}
                                    </a>
                                </td>
                                <td>{{ booking.user.get_full_name|default:booking.user.username|truncatechars:15 }}</td>
                                <td>{{ booking.booking_date|date:"Y/m/d" }}</td>
                                <td>
                                    <span class="badge {% if booking.status == 'confirmed' %}bg-success{% elif booking.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ booking.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">لا توجد حجوزات حديثة</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Messages -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">أحدث الرسائل</h6>
                <a href="{% url 'hall_booking:admin_contacts_list' %}" class="btn btn-sm btn-primary">
                    عرض الكل
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>الموضوع</th>
                                <th>التاريخ</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for message in recent_messages|slice:":5" %}
                            <tr>
                                <td>{{ message.name|truncatechars:15 }}</td>
                                <td>
                                    <a href="{% url 'hall_booking:admin_contact_detail' message.id %}">
                                        {{ message.subject|truncatechars:20 }}
                                    </a>
                                </td>
                                <td>{{ message.created_at|date:"Y/m/d" }}</td>
                                <td>
                                    {% if message.is_read %}
                                    <span class="badge bg-secondary">تمت القراءة</span>
                                    {% else %}
                                    <span class="badge bg-primary">جديد</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">لا توجد رسائل واردة</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">إحصائيات الحجوزات الشهرية</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" data-config='{
                    "type": "line",
                    "data": {
                        "labels": {{ month_labels|safe }},
                        "datasets": [{
                            "label": "عدد الحجوزات",
                            "data": {{ monthly_bookings|safe }},
                            "backgroundColor": "rgba(78, 115, 223, 0.05)",
                            "borderColor": "rgba(78, 115, 223, 1)",
                            "pointBackgroundColor": "rgba(78, 115, 223, 1)",
                            "pointBorderColor": "#fff",
                            "pointHoverBackgroundColor": "#fff",
                            "pointHoverBorderColor": "rgba(78, 115, 223, 1)",
                            "pointRadius": 4,
                            "pointHoverRadius": 6,
                            "borderWidth": 2,
                            "tension": 0.3,
                            "fill": true
                        }]
                    },
                    "options": {
                        "responsive": true,
                        "maintainAspectRatio": false,
                        "plugins": {
                            "legend": {
                                "display": true,
                                "position": "top",
                                "rtl": true,
                                "labels": {
                                    "font": {
                                        "family": "Tajawal, sans-serif"
                                    }
                                }
                            },
                            "tooltip": {
                                "backgroundColor": "rgba(0, 0, 0, 0.8)",
                                "titleFont": {
                                    "size": 14,
                                    "weight": "bold",
                                    "family": "Tajawal, sans-serif"
                                },
                                "bodyFont": {
                                    "size": 13,
                                    "family": "Tajawal, sans-serif"
                                },
                                "callbacks": {
                                    "label": "function(context) { return 'عدد الحجوزات: ' + context.raw; }"
                                },
                                "rtl": true
                            }
                        },
                        "scales": {
                            "y": {
                                "beginAtZero": true,
                                "ticks": {
                                    "stepSize": 1,
                                    "font": {
                                        "family": "Tajawal, sans-serif"
                                    }
                                },
                                "grid": {
                                    "color": "rgba(0, 0, 0, 0.05)"
                                }
                            },
                            "x": {
                                "ticks": {
                                    "font": {
                                        "family": "Tajawal, sans-serif"
                                    }
                                },
                                "grid": {
                                    "display": false
                                }
                            }
                        },
                        "events": '{% url "hall_booking:admin_bookings_calendar" %}',
                        "locale": "ar-SA",
                        "rtl": true
                    }
                }'>
                    <canvas height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <!-- Halls Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-right-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            إجمالي القاعات</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ halls_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-building fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="{% url 'hall_booking:admin_halls_list' %}" class="small text-decoration-none">
                    عرض التفاصيل <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Bookings Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-right-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            إجمالي الحجوزات</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ bookings_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="{% url 'hall_booking:admin_bookings_list' %}" class="small text-decoration-none">
                    عرض التفاصيل <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Messages Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-right-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            الرسائل الواردة</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ messages_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-envelope fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="{% url 'hall_booking:admin_contacts_list' %}" class="small text-decoration-none">
                    عرض التفاصيل <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Pending Requests Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-right-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            الحجوزات المعلقة</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_bookings_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="{% url 'hall_booking:admin_bookings_list' %}?status=pending" class="small text-decoration-none">
                    عرض التفاصيل <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Bookings -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">أحدث الحجوزات</h6>
                <a href="{% url 'hall_booking:admin_bookings_list' %}" class="btn btn-sm btn-primary">
                    عرض الكل
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>رقم الحجز</th>
                                <th>اسم القاعة</th>
                                <th>اسم المستخدم</th>
                                <th>تاريخ الحجز</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in recent_bookings %}
                            <tr>
                                <td>#{{ booking.id }}</td>
                                <td>{{ booking.hall.name }}</td>
                                <td>{{ booking.user.get_full_name|default:booking.user.username }}</td>
                                <td>{{ booking.booking_date|date:"Y/m/d" }}</td>
                                <td>
                                    <span class="badge {% if booking.status == 'confirmed' %}bg-success{% elif booking.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ booking.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'hall_booking:admin_booking_detail' booking.id %}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">لا توجد حجوزات حديثة</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Messages -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">أحدث الرسائل</h6>
                <a href="{% url 'hall_booking:admin_contacts_list' %}" class="btn btn-sm btn-primary">
                    عرض الكل
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الموضوع</th>
                                <th>تاريخ الإرسال</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for message in recent_messages %}
                            <tr>
                                <td>{{ message.name }}</td>
                                <td>{{ message.email }}</td>
                                <td>{{ message.subject|truncatechars:30 }}</td>
                                <td>{{ message.created_at|date:"Y/m/d" }}</td>
                                <td>
                                    <span class="badge {% if message.is_read %}bg-secondary{% else %}bg-primary{% endif %}">
                                        {% if message.is_read %}تم القراءة{% else %}جديد{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'hall_booking:admin_contact_detail' message.id %}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">لا توجد رسائل واردة</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
