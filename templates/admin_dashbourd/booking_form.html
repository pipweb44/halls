{% extends 'admin_dashbourd/base.html' %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'hall_booking:admin_bookings_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i> رجوع إلى قائمة الحجوزات
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.hall.id_for_label }}" class="form-label">القاعة</label>
                            {{ form.hall }}
                            {% if form.hall.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.hall.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.customer_name.id_for_label }}" class="form-label">اسم الزبون</label>
                            {{ form.customer_name }}
                            {% if form.customer_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer_name.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.start_datetime.id_for_label }}" class="form-label">تاريخ ووقت البداية</label>
                            <input type="datetime-local" name="{{ form.start_datetime.name }}" 
                                   class="form-control" id="{{ form.start_datetime.id_for_label }}"
                                   value="{{ form.start_datetime.value|default:'' }}" required>
                            {% if form.start_datetime.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.start_datetime.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.end_datetime.id_for_label }}" class="form-label">تاريخ ووقت النهاية</label>
                            <input type="datetime-local" name="{{ form.end_datetime.name }}" 
                                   class="form-control" id="{{ form.end_datetime.id_for_label }}"
                                   value="{{ form.end_datetime.value|default:'' }}" required>
                            {% if form.end_datetime.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.end_datetime.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.customer_email.id_for_label }}" class="form-label">البريد الإلكتروني</label>
                            {{ form.customer_email }}
                            {% if form.customer_email.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer_email.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.customer_phone.id_for_label }}" class="form-label">رقم الهاتف</label>
                            {{ form.customer_phone }}
                            {% if form.customer_phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer_phone.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-group">
                            <label for="{{ form.event_title.id_for_label }}" class="form-label">عنوان المناسبة</label>
                            {{ form.event_title }}
                            {% if form.event_title.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.event_title.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-group">
                            <label for="{{ form.event_description.id_for_label }}" class="form-label">تفاصيل إضافية</label>
                            {{ form.event_description }}
                            {% if form.event_description.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.event_description.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.attendees_count.id_for_label }}" class="form-label">عدد الحضور</label>
                            {{ form.attendees_count }}
                            {% if form.attendees_count.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.attendees_count.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.status.id_for_label }}" class="form-label">حالة الحجز</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.status.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.total_price.id_for_label }}" class="form-label">السعر الإجمالي</label>
                            <div class="input-group">
                                {{ form.total_price }}
                                <span class="input-group-text">د.ل</span>
                            </div>
                            {% if form.total_price.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.total_price.errors|join:", " }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> حفظ
                    </button>
                    <a href="{% url 'hall_booking:admin_bookings_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Enable Bootstrap form validation
(function () {
    'use strict'
    
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation')
    
    // Loop over them and prevent submission
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                
                form.classList.add('was-validated')
            }, false)
        })
})()

// Add event listeners to calculate price when dates change
const startDateInput = document.getElementById('{{ form.start_datetime.id_for_label }}');
const endDateInput = document.getElementById('{{ form.end_datetime.id_for_label }}');
const hallSelect = document.getElementById('{{ form.hall.id_for_label }}');
const totalPriceInput = document.getElementById('{{ form.total_price.id_for_label }}');

function calculatePrice() {
    if (!startDateInput.value || !endDateInput.value || !hallSelect.value) return;
    
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    const hours = Math.ceil((endDate - startDate) / (1000 * 60 * 60));
    const hallPrice = parseFloat(hallSelect.options[hallSelect.selectedIndex].getAttribute('data-price') || 0);
    
    if (hours > 0 && hallPrice > 0) {
        totalPriceInput.value = (hours * hallPrice).toFixed(2);
    } else {
        totalPriceInput.value = '';
    }
}

startDateInput.addEventListener('change', calculatePrice);
endDateInput.addEventListener('change', calculatePrice);
hallSelect.addEventListener('change', calculatePrice);
</script>
{% endblock %}
